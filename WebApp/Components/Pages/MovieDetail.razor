@page "/movies/detail/{Id:int}"
@rendermode InteractiveServer

@using Blazorise
@using System.Net.Http.Json
@using Contracts.Dtos.Read
@using Contracts.Enums
@inject IHttpClientFactory ClientFactory
@inject NavigationManager Nav

<PageTitle>Filmdetails</PageTitle>

@if (movie is null)
{
    <Alert Color="Color.Light" Visible>Film wird geladen…</Alert>
}
else
{
    <Card>
        <CardHeader>
            <CardTitle>@movie.Title</CardTitle>
        </CardHeader>

        <CardBody>
            <Paragraph class="mb-3">@movie.Plot</Paragraph>

            <ListGroup>
                <ListGroupItem>
                    <div class="d-flex justify-content-between">
                        <strong>USK</strong>
                        <span>@((int)movie.AgeRating)</span>
                    </div>
                </ListGroupItem>

                <ListGroupItem>
                    <div class="d-flex justify-content-between">
                        <strong>Release</strong>
                        <span>@movie.ReleaseDate</span>
                    </div>
                </ListGroupItem>

                <ListGroupItem>
                    <div class="d-flex justify-content-between">
                        <strong>Rating</strong>
                        <span>@movie.Rating</span>
                    </div>
                </ListGroupItem>

                <ListGroupItem>
                    <div class="d-flex justify-content-between">
                        <strong>Laufzeit</strong>
                        <span>@movie.Runtime min</span>
                    </div>
                </ListGroupItem>

                @if (movie.Budget > 0)
                {
                    <ListGroupItem>
                        <div class="d-flex justify-content-between">
                            <strong>Budget</strong>
                            <span>@movie.Budget.ToString("C")</span>
                        </div>
                    </ListGroupItem>
                }

                <ListGroupItem>
                    <div class="d-flex justify-content-between align-items-start">
                        <strong class="me-2">Genres</strong>
                        <span class="flex-grow-1">
                            @foreach (var g in movie.Genres)
                            {
                                <Badge Color="Color.Secondary" Class="me-1 mb-1" Pill style="cursor:pointer"
                                    @onclick="() => OpenGenreAsync(g.Id!.Value, g.Name)">
                                    @g.Name
                                </Badge>
                            }
                        </span>
                    </div>
                </ListGroupItem>
            </ListGroup>

            <Divider class="my-3" />

            <strong>Beteiligte</strong>
            <ListGroup class="mt-2">
                @if (movie.Involvements?.Any() == true)
                {
                    @foreach (var p in movie.Involvements)
                    {
                        <ListGroupItem>
                            <div class="d-flex justify-content-between flex-wrap gap-2">
                                <span>@(p?.FirstName) @(p?.LastName)</span>
                                <span>
                                    @foreach (var r in (p?.Roles ?? Enumerable.Empty<Contracts.Enums.MovieRole>()))
                                    {
                                        if (p?.Id is int pid)
                                        {
                                            <Badge Color="Color.Info" Class="ms-1 mb-1" Pill style="cursor:pointer"
                                                @onclick="@(() => OpenPersonRoleAsync(pid, r, $"{p?.FirstName} {p?.LastName}"))">
                                                @r
                                            </Badge>
                                        }
                                        else
                                        {
                                            <Badge Color="Color.Info" Class="ms-1 mb-1" Pill>@r</Badge>
                                        }
                                    }
                                </span>
                            </div>
                        </ListGroupItem>
                    }
                }
                else
                {
                    <ListGroupItem>
                        <span class="text-muted">Keine Beteiligten vorhanden.</span>
                    </ListGroupItem>
                }
            </ListGroup>
        </CardBody>
    </Card>
}

<Modal @bind-Visible="showModal" Size="ModalSize.Large" Scroll="ModalScroll.Vertical">
    <ModalHeader>
        <ModalTitle>@modalTitle</ModalTitle>
    </ModalHeader>

    <ModalBody>
        @if (modalLoading)
        {
            <Alert Color="Color.Light" Visible>Lade Filme…</Alert>
        }
        else if (!string.IsNullOrWhiteSpace(modalError))
        {
            <Alert Color="Color.Danger" Visible>@modalError</Alert>
        }
        else if (modalMovies.Count == 0)
        {
            <Alert Color="Color.Warning" Visible>Keine Filme gefunden.</Alert>
        }
        else
        {
            <ListGroup>
                @foreach (var m in modalMovies)
                {
                    <ListGroupItem>
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div>
                                <strong>@(m?.Title ?? "Unbenannt")</strong>
                                <div class="text-muted small">
                                    @(m is not null ? m.ReleaseDate.ToString() : "—") • Rating @(m is not null ? m.Rating.ToString() : "—")
                                </div>
                                <div class="mt-1">
                                    @if (m?.Genres?.Any() == true)
                                    {
                                        @foreach (var gg in m.Genres)
                                        {
                                            <Badge Color="Color.Secondary" Class="me-1 mb-1" Pill>@(gg?.Name ?? "Unbenannt")</Badge>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted small">—</span>
                                    }
                                </div>
                            </div>

                            @if (m?.Id is int mid)
                            {
                                <Button Color="Color.Primary"
                                        Size="Size.Small"
                                        @onclick="@(() => Nav.NavigateTo($"/movies/detail/{mid}"))">
                                    Details
                                </Button>
                            }
                            else
                            {
                                <Button Color="Color.Secondary" Size="Size.Small" Disabled>Details</Button>
                            }
                        </div>
                    </ListGroupItem>
                }
            </ListGroup>
        }
    </ModalBody>

    <ModalFooter>
        <Button Color="Color.Secondary" Outline @onclick="() => showModal = false">Schließen</Button>
    </ModalFooter>
</Modal>


@code {
    [Parameter] public int Id { get; set; }
    private MovieReadDto? movie;

    private bool showModal;
    private bool modalLoading;
    private string modalTitle = string.Empty;
    private string? modalError;
    private List<MovieReadDto> modalMovies = new();

    protected override async Task OnParametersSetAsync()
    {
        var http = ClientFactory.CreateClient("MoviesApi");
        var url = new Uri(http.BaseAddress!, $"movie-archive/movie/by-id/{Id}");

        var json = new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web);
        json.Converters.Add(new System.Text.Json.Serialization.JsonStringEnumConverter());

        movie = await http.GetFromJsonAsync<MovieReadDto>(url, json);
    }

    private async Task OpenGenreAsync(int genreId, string genreName)
    {
        modalTitle = $"Filme im Genre: {genreName}";
        await LoadMoviesAsync(new Uri(GetApiBase(), $"movie-archive/genre/{genreId}"));
    }

    private async Task OpenPersonRoleAsync(int personId, MovieRole role, string personName)
    {
        modalTitle = $"Filme von {personName} als {role}";
        var query = $"movie-archive/movie/by-person-role?role={role}&personId={personId}";
        await LoadMoviesAsync(new Uri(GetApiBase(), query));
    }

    private async Task LoadMoviesAsync(Uri endpoint)
    {
        showModal = true;
        modalLoading = true;
        modalError = null;

        try
        {
            var http = ClientFactory.CreateClient("MoviesApi");

            var json = new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web);
            json.Converters.Add(new System.Text.Json.Serialization.JsonStringEnumConverter());

            modalMovies = await http.GetFromJsonAsync<List<MovieReadDto>>(endpoint, json) ?? new List<MovieReadDto>();
        }
        catch (Exception ex)
        {
            modalError = ex.Message;
            modalMovies = new List<MovieReadDto>();
        }
        finally
        {
            modalLoading = false;
            StateHasChanged();
        }
    }

    private Uri GetApiBase()
    {
        var http = ClientFactory.CreateClient("MoviesApi");
        return http.BaseAddress!;
    }
}
